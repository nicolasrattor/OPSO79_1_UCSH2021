---
title: "Muestreo en R"
subtitle: "Funciones básicas"
author: "Rodrigo Medel y Nicolás Ratto"
institute: "Curso Metodología I. Universidad de Chile, FACSO."
date: "2021/05/24 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css:  [default, fc, fc-fonts]
    lib_dir: libs
    nature:
      ratio: '3:2'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

<style type="text/css">
.remark-slide-content {
    font-size: 23px;
    padding: 1em 4em 1em 4em;
}
</style>


```{r echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(tidyverse)
```



# Introducción

--

Una buena muestra, permite una "estimación" de calidad.

--

La **muestra** es la selcción de los elementos a estudiar desde la población. 

--

La **población** tiene un parámetro desconocido que queremos conocer (eg. número de fumadores en Chile). 

--

Como preguntarle a toda la población es muy costoso, seleccionamos solamente a un conjunto de personas. 

--

A partir de los datos proporcionados por la muestra seleccionada, vamos a estimar o inferir un valor aproximado del parámetro de la población. 


--

La **selección aleatoria** de elementos resulta condición necesaria para la inferencia de datos muestrales a valores poblacionales, con un nivel de imprecisión conocido.



---

# Criterios de selección de la muestra

Sin embargo, no todas las formas de seleccionar a una muestra son "probabilísticas". El muestreo por cuotas, por ejemplo, es "no probabilistico". 

--

El muestreo probabilístico infiere a la población utilizando como guía los preceptos de la teoría de la estimación. Se caracteriza porque todos los elementos tienen una probabilidad conocida y distinta de cero de ser parte de la muestra. 

--

Sí tenemos un listado de los elementos (marco muestral), y seleccionamos aleatoriamente solamente algunos elementos a estudiar, estamos en un **muestreo probabilistico**. Esta es la base de otros diseños más complejos. 

--

Por el contrario, sino tenemos un listado, y simplemente nos arrojamos al "terreno" a levantar información, estaríamos haciendo un **muestro no probabilistico**. 

--

El clásico ejemplo es la encuesta online sobre algún tema X que seguramente hemos respondido ahora en pandemia. 



---

# Muestreo probabilístico


--

Un ejemplo simple de selección aleatoria.

--

Creamos una base de datos de 19.678.363 casos, [el número de personas en Chile según el INE](https://www.ine.cl/estadisticas/sociales/demografia-y-vitales/proyecciones-de-poblacion), que contenga 1.492.522 extranjeros.

--

```{r}
poblacion<-data.frame(id=c(seq(1:19678363)),
                      extranjers=c(rep("ext",1492522),rep("nac",19678363-1492522)))
```
--

```{r}
table(poblacion$extranjers)#<<  
prop.table(table(poblacion$extranjers))#<<  
```


---

# La selección aleatoria

Sin conocimiento específico de la teoría para el cálculo de muestra, sacaremos una muestra de 500, suponiendo que la distribución de extranjeros de esta se parecerá a la de la población.

--

Sacamos la muestra (dplyr):

```{r}
muestra<-sample_n(poblacion,500) #<<
#muestra<-poblacion[poblacion$id %in% sample(poblacion$id,500),] # forma "dificil"
```

--

Y observamos su distribución:

```{r}
prop.table(table(muestra$extranjers))   ## Se parece bastante...  #<<  
```


---

# La selección aleatoria

¿Fue suerte?, veamos de nuevo...

--

```{r}
muestra<-sample_n(poblacion,500) #<< 
prop.table(table(muestra$extranjers))            #<<  
```

--

De nuevo

```{r}
muestra<-sample_n(poblacion,500) #<<
prop.table(table(muestra$extranjers))            #<<  
```

---

# La selección aleatoria

Cada vez que actualicemos esta presentación, la muestra seleccionada se nos va a modificar. 

--

Esto generará que cualquier análisis que queramos hacer con los datos no será reproducible, ya que cada vez que saquemos una muestra esta se modificará.

--

Manteniendo el azar, `R` nos permite fijar la selección aleatoria. Esto se logra "fijando una semilla".

--

```{r}
set.seed(17) ## número arbitrario             #<<  
```

Con esto, la distribución de la muestra que saquemos siempre será 0,064 (6,4%).

--

Veamos si es cierto...

---

# La selección aleatoria

```{r}
muestra<-sample_n(poblacion,500) #<< 
prop.table(table(muestra$extranjers))               #<<  
```

Efectivamente. Veamos de nuevo...

--

```{r}
set.seed(17)                                     #<<  
muestra<-sample_n(poblacion,500) #<< 
prop.table(table(muestra$extranjers))            #<<  
```


---

# La selección aleatoria

Las estimaciones que obtengamos de cada muestra de la población se ubicará en torno al parámetro poblacional. 

--

Ahora veremos que tan cierta es esta afirmación. Vamos a sacar 500 muestras aleatorias de 500 casos. 

--

Escribimos un código para esto: 

```{r}
set.seed(1918)                               #<<  

base<-data.frame(muestra=c(1:500),
                 ext=rep(NA,500),
                 nac=rep(NA,500))

for(i in 1:nrow(base)){                            #<<  
  base[i,2:3]<-sample_n(poblacion,size=500) %>% select(extranjers) %>%    #<<  
    table() %>% prop.table()                       #<<  
}                                                #<< 

```

---

# La selección aleatoria

```{r}
str(base)          #<<  
```

--

La media promedio de trabajadores extranjeros de las 2000 muestras es:
```{r}
mean(base$ext)   ## OMG! en la población era 0.07584584            #<<  
```

---

# Magia negra

--

.pull-left[
```{r echo=FALSE,warning=FALSE,message=FALSE,out.width="100%",out.height="100%"}

base %>% ggplot(aes(x=ext))+geom_histogram()+geom_vline(xintercept = mean(base$ext),linetype="dashed", color = "red") + theme_bw() #<<  

```
]

---

# Paquete para calcular tamaños muestrales

Hay algunas páginas como [SurveyMonkey](https://www.surveymonkey.com/mp/sample-size-calculator/) o [Calculator](https://www.calculator.net/sample-size-calculator.html)

--

$$n=(1-\frac{n}{N})*\frac{z^2_{a/2}(s^2)}{e^2}$$

--

```{r message=FALSE,warning=FALSE}
library(samplingbook)
```

--

```{r}
sample.size.prop(e=0.03, P = 0.5, N = 19000000, level = 0.95)
```

--

```{r}
sample.size.mean(e=0.03, S = 1, N = 19000000, level = 0.95)
```




---

# La selección aleatoria

--

Una muestra será representativa si la distribución de las variables es análoga en la población y en la muestra. En general, nunca habrá una exactitud y, en general, tampoco podremos saber esta exactitud, ya que desconocemos el parámetro poblacional.

--

Sin mayor elaboración, el azar parece un procedimiento apropiado para seleccionar los elementos que compondrán la muestra, en tanto los elementos seleccionados se acercan, por arriba o por abajo, a nuestro parámetro poblacional. Sin embargo, las distribuciones no son idénticas.

--

La teoría de la inferencia estadística nos permitirá controlar la "incertidumbre" de nuestras estimaciones.

--

La selección aleatoria no supone que el grado de imprecisión asociado a las estimaciones sea necesariamente pequeño. Lo que sí permite es conocer la magnitud de la imprecisión que se comete al inferir a la población origen de la muestra.


---

# Muestreo probabilístico

## Muestreo aleatorio simple

Es la base de los diseños muestrales que se presentarán a continuación.

--

Tenemos una lista de elementos a seleccionar, los cuáles se eligen aleatoriamente en base a un número definido previamente.

--

Cada uno de estos elementos del listado tienen la misma probabilidad de ser elegidos. 

--

Con diseños más complejos podemos mantener la misma precisión que un muestreo aleatorio simple, pero necesitando menos elementos en la muestra (más económico)




---

# Muestreo probabilístico

## Muestreo estratificado

El estrato es un subconjunto de elementos de la muestra, homogéneo en relación a un conjunto de variables relevantes.

--

La selección de elementos se realiza después de establecidos los estratos y asignado cada elemento al estrato de pertenencia.

--

En encuestas a empresas, por ejemplo, se suelen utilizar diseños estratificados. Como variables de estratificación suelen considerarse los tamaños de las empresas y/o el sector económico. 

--

La minería constituiría un estrato y el sector comercio otro estrato. Estos grupos se constituyen en estratos, en tanto al considerar una variable de interés (eg. remuneraciones o ventas anuales), las empresas dentro de cada estrato presentan una alta semejanza.

--

Los elementos al interior de cada estrato se seleccionarán aleatoriamente. 

---

# Muestreo probabilístico

## Muestreo estratificado

Lo más básico es elegir para cada estrato un número proporcional de elementos (**Afijación proporcional**).

--

$n_{i}=n\cdot\frac{N_{i}}{N}$

--

Si se selecciona una muestra de 1.000 casos, de una población de 10.000 que fue ordenada en 10 estratos. 

Para el estrato i de tamaño 1.500 necesitamos seleccionar en la muestra 150 casos:

```{r}
1000 * (1500/10000)
```

---

# Muestreo probabilístico

## Muestreo estratificado

Si el tamaño del estrato en la población es de 2500:

```{r}
1000 * (2500/10000)
```

--

|  estrato | poblacion | muestra |
|---|---|---|
|1|1500|150|
|2|2500|250|
|3|50|5|
|estrato_i|N_i|n_i|
|Total|10000|1000|


---

# Muestreo probabilístico

## Muestreo estratificado

La otra alternativa es la **afijación óptima**. El tamaño de la muestra seleccionada para cada estrato varía no solamente en términos proporcionales, sino también respecto a la varianza de cada estrato.

--

La lógica es que sí los elementos al interior de un estrato son muy diferentes entre sí necesitaremos más casos en nuestra muestra, que para aquellos estratos cuyos elementos son más similares entre sí.

--

El tamaño del estrato $i$:

$n_{i}=n\cdot w_{i}$

--

$n$ = tamaño muestral (global)

$w_{i}=\frac{N_{i}s_{i}}{\sum_{k=1}^{K}N_{k}s_{k}}$


---

# Muestreo por conglomerados

El conglomerado es "lo contrario" al estrato: heterogeneidad de los elementos dentro del conglomerado y homogeneidad de los conglomerados entre sí.

--

**Muy importante:** *"Los conglomerados son parecidos entre sí, por tanto se seleccionan sólo algunos para conformar la muestra. No se requiere de la lista de todos los elementos de la población, sólo el listado de elementos de los conglomerados elegidos."* (Vivanco, 2006: 144).

--

## Conglomerados monoetápicos

La selección de elementos en los conglomerados que componen la muestra se realiza mediante muestreo aleatorio simple.


---

# Muestreo por conglomerados

## Conglomerados polietápicos

La CASEN es un buen ejemplo

--

Selección aleatoria de municipios 
  -> selección aleatoria de zonas censales dentro de los municipios 
    -> selección aleatoria de viviendas de las zonas censales de los municipios
      -> personas dentro de las viviendas
      




---

# Muestreo no probabilístico

Es difícil cumplir con las exigencias de la selección aleatoria. Muchas veces no contamos con marcos muestrales con las unidades que queremos investigar, o no tenemos los recursos para insistirle a la unidad seleccionada aleatoriamente para que nos entregue información.  

--

En el mundo de lo no probabilístico no es posible conocer la precisión del parámetro poblacional. 

--

El muestreo no probabilístico más elaborado es el **muestreo por cuotas**. El muestrista decide qué variables de cuota se utilizarán, el tamaño de cada cuota y el número de cuotas que comprende la muestra. 

--

La distribución de nuestra muestra debe ser similar a la de la población. Si el 10% de la población son mujeres menores de 25 años, nuestra muestra debe consituirse por una proporción similar de mujeres de dicha edad. 



---

# El tamaño de la muestra

El tamaño de la muestra se ve condicionado por el nivel de confianza, el error máximo admisible, la dispersión de los datos, los recursos económicos y el tamaño de la población. 

--

$n=(1-\frac{n}{N})*\frac{z^2_{a/2}(s^2)}{e^2}$

--

$z^2_{a/2}$ = Valor del coeficiente de confianza –elevado al cuadrado–. Corresponde a un valor de la curva normal asociado al nivel de confianza con que se hará la estimación.

$e^2$ = Valor del error máximo admisible elevado al cuadrado

$s^2$ = Varianza de la población. Puede ser reeplazada por $(p * q)$ (varianza máxima = 0,5 * 0,5).

---

# N muestra y error

Si definimos errores elevados la muestra es pequeña. Se definimos errores pequeños la muestra asociada es grande.

--

```{r echo=FALSE, warning=FALSE, message=FALSE, out.width="50%"}
## Población 19 millones. 95% nivel de confianza.

d=(19000000*(1.96^2)*(0.5*0.5))
n=((5^2)*(19000000-1))+(1.96^2)*(0.5*0.5)
e<-d/n*10000

error<-c(0.35,0.4,0.45,0.5,1,1.5,2,2.5,3,3.5,4)
n<-c(rep(NA,length(error)))
base<-data.frame(error,n)


for(i in 1:nrow(base)){
  base[i,2]<-round((19000000*(1.96^2)*(0.5*0.5))/(((error[i]^2)*(19000000-1))+(1.96^2)*(0.5*0.5))*10000)
}

base %>% ggplot(aes(x=n,y=error))+geom_line()+geom_point() + theme_bw() + labs(title="Tamaño de muestra y error máximo admisible",y="Error (%)",x="Tamaño muestra",subtitle = "Un error de 3% es razonable (n=1067 al 95%)") + 
  scale_x_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))


```

---

# N muestra y nivel de confianza

El nivel de confianza de la estimación es decisión del muestrista y función de la precisión con que se desea estimar el valor de la población. Convencionalmente se utilizan niveles de confianza de 95% en las ciencias sociales (1,96 puntaje z).

--

```{r echo=FALSE, warning=FALSE, message=FALSE,  out.width="50%"}
ncz<-c(1.64,1.96,2.58, 3, 3.5, 3.8)
nc<-c("90%","95%","99%","99,87%", "99,96%", "99,99%")
n<-c(rep(NA,length(ncz)))
base<-data.frame(nc,ncz,n)


for(i in 1:nrow(base)){
  base[i,3]<-round((19000000*(ncz[i]^2)*(0.5*0.5))/(((3^2)*(19000000-1))+(ncz[i]^2)*(0.5*0.5))*10000)
}

base %>% ggplot(aes(x=n,y=ncz))+geom_line()+geom_point() + theme_bw() + labs(title="Tamaño de muestra y nivel de confianza",y="Puntaje z",x="Tamaño muestra",subtitle = "Error max. admisible en 3%") + 
  scale_x_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))

```

---

# N muestra y nivel de confianza

El tamaño de la muestra no se ve sustantivamente influenciado por el tamaño de la población origen de la muestra.

En poblaciones superiores a 100.000 casos la influencia del tamaño de la población es ínfima en el cálculo del tamaño de la muestra.

```{r echo=FALSE, warning=FALSE, message=FALSE,  out.width="50%"}
poblacion<-c(100,10000,50000,100000,200000,300000,500000,600000,700000,800000,900000,1000000)
n<-c(rep(NA,length(poblacion)))
base<-data.frame(poblacion,n)

library(samplingbook)

for(i in 1:nrow(base)){
  
base[i,2]<-sample.size.prop(e=0.01, P = 0.5, N = poblacion[i], level = 0.95)$n

}

base %>% ggplot(aes(y=n,x=poblacion))+geom_line()+geom_point() + theme_bw() + labs(title="Tamaño de muestra y de la poblacion",x="Tamaño población",y="Tamaño muestra",subtitle = "Error max. admisible en 3% y 95% de confianza") + 
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE),limits = c(0,10000))+
    scale_x_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))



```

---

# N muestra y heterogeneidad de los datos

En la práctica se calcula la muestra considerando la varianza de una pregunta o varias preguntas que se consideren relevantes para la investigación. A mayor varianza, más casos se necesitarán. Si no hay información se supone varianza máxima (`r 0.5^2`)

--

```{r echo=FALSE, warning=FALSE, message=FALSE,  out.width="50%"}

P<-c(0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5)
n<-c(rep(NA,length(P)))
base<-data.frame(P,n)

for(i in 1:nrow(base)){
  
base[i,2]<-sample.size.prop(e=0.01, P = P[i], N = 100000, level = 0.95)$n

}

base %>% ggplot(aes(x=n,y=P))+geom_point()+geom_line() + theme_bw() + labs(title="Tamaño de muestra y varianza",y="Varianza",x="Tamaño muestra",subtitle = "Error max. admisible en 3%, 95% de confianza y población 100.000") + 
  scale_x_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))

```

---

# Retomando

El cálculo del tamaño de la muestra no tiene una solución única y verdadera. Para su determinación se consideran tanto elementos objetivos como subjetivos. Estos últimos pueden variar de muestrista a muestrista. 

El muestreo aleatorio simple sólo puede tener interés cuando el listado de elementos está disponible. 

---

# Ponderación y autoponderación

Una muestra es autoponderada cuando todos los elementos han tenido la misma probabilidad de pertenecer a la muestra. 

--

Muestras en que la probabilidad de selección no es equiprobable dan lugar a resultados sesgados. Para evitarlo, se recurre a la ponderación. 

--

Ponderar es darle pesos diferenciales a los elementos de la muestra, para que distribuyan lo más similar posible a la población.

--

En una encuesta online sobre teletrabajo en el sector público organizada por las asociaciones de trabajadores, es probable que quienes más respondan sean los jóvenes y/o quienes son más cercanos "políticamente" a las asociaciones.

---

# Crear ponderadores

Dividir el porcentaje de la categoría en la población,  con el porcentaje de la categoría en la muestra.

Si en la población los extranjeros son el 7%, pero en nuestra muestra son 3%, entonces 7/3 =`r 7/3`. Los extranjeros están subrepresentados, por lo que el peso es mayor a 1. 

--

Esto significa que a todos los extranjeros de la muestra se les agregará una variable de "ponderación" con el valor `r 7/3`, mientras que a los nacionales una con el valor 93% / 97% = `r 93/97`. 



---

# El proceso de estimación

Para estimar el valor del parámetro poblacional existen dos alternativas: (i) definir un estadístico como estimación del parámetro poblacional (estimación puntual) o (ii) establecer en torno a un estadístico un intervalo de confianza para estimar en términos probabilísticos el parámetro. 

--

La segunda alternativa es la más apropiada.

--

La amplitud del intervalo (la precisión de nuestra inferencia), dependerá del nivel de confianza que hayamos establecido en el diseño de la muestra. Además, del tamaño de la muestra y la desviación estandar. 

--

$[\overline{x} + z_{a/2}\frac{s}{\sqrt{n}} , \overline{x} - z_{a/2}\frac{s}{\sqrt{n}}]$


---

# Tratamiento de la no respuesta

Básicamente dos razones inciden en no satisfacer el tamaño de muestra:

+ presencia de no elegibles en el marco muestral

+ presencia de no respuestas entre los elegibles

La sobre muestra soluciona el problema. Se seleccionan un x% más de casos, esperando determinada proporción de no respuesta y de no elegibilidad. 

El aumento del tamaño de la muestra es una solución de uso común en el tratamiento de la no respuesta. Resulta de fácil aplicación; sin embargo, es de dudosa eficacia. Se requiere hacer un análisis de la no respuesta.

---

# Recursos consultados y utilizados

+ Babbie, E. (2020).

+ Vivanco, M. (2006).

+ Lohr, S. (2000).

+ [Muestreo aleatorio estratificado en R](https://estadistica-dma.ulpgc.es/MGC/muestreo_Estratificado.html).

+ [Wickham, H. y Grolemund, G. (2020)](https://es.r4ds.hadley.nz/). R para Ciencia de Datos.

+ [Xaringan: Presentation Ninja, de Yihui Xie](https://github.com/yihui/xaringan). Para generar esta presentación.






